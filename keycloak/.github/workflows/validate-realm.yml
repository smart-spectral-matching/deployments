name: Validate Realm JSON

on:
  push:
    paths:
      - 'realm_files/**'
  pull_request:
    paths:
      - 'realm_files/**'

jobs:
  validate:
    name: Validate JSON files in realm_files/
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(realm_files/*.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No realm JSON files found in realm_files/"
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Validating $f"
            jq empty "$f"
          done

      - name: Generate patched ssm.json and validate
        if: always()
        run: |
          set -euo pipefail
          # If the generator exists, run it and validate the resulting JSON
          if [ -x scripts/generate_ssm.sh ]; then
            echo "Generating patched ssm.json (no env vars set)"
            scripts/generate_ssm.sh > /tmp/ssm.generated.json
            echo "Validating generated ssm.json"
            jq empty /tmp/ssm.generated.json
          else
            echo "No generator script found; skipping generated ssm.json validation"
          fi
