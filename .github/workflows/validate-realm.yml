name: Validate Realm JSON

on:
  push:
    paths:
      - 'keycloak/realm_files/**'
  pull_request:
    paths:
      - 'keycloak/realm_files/**'

jobs:
  validate:
    name: Validate JSON files in realm_files/
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate JSON files
        run: |
          set -euo pipefail
          shopt -s nullglob
          files=(keycloak/realm_files/*.json)
          if [ ${#files[@]} -eq 0 ]; then
            echo "No realm JSON files found in keycloak/realm_files/"
            exit 0
          fi
          for f in "${files[@]}"; do
            echo "Validating $f"
            jq empty "$f"
          done

      - name: Generate patched ssm.json and validate (default)
        if: always()
        run: |
          set -euo pipefail
          if [ -x keycloak/scripts/generate_ssm.sh ]; then
            echo "Generating patched ssm.json (no env vars set)"
            keycloak/scripts/generate_ssm.sh > /tmp/ssm.generated.json
            echo "Validating generated ssm.json"
            jq empty /tmp/ssm.generated.json
          else
            echo "No generator script found; skipping generated ssm.json validation"
          fi

  validate-generated:
    name: Validate generated ssm.json with example envs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        case: [ldap, google, both]
                both)
                  echo "Testing combined LDAP+Google patch case"
                  FEDERATE_LDAP=true LDAP_URL="ldap://ldap.example.local" USERSDN="dc=example,dc=local" \
                    GOOGLE_IDP=true GOOGLE_CLIENT_ID="ci-client-id" GOOGLE_SECRET="ci-secret" \
                    keycloak/scripts/generate_ssm.sh > /tmp/ssm.generated.json
                  jq empty /tmp/ssm.generated.json
                  # Check LDAP URL
                  jj=$(jq -r '.components[0].config.connectionUrl[0] // empty' /tmp/ssm.generated.json)
                  echo "connectionUrl[0]=${jj}"
                  if [ "${jj}" != "ldap://ldap.example.local" ]; then
                    echo "ERROR: LDAP URL not found in generated ssm.json" >&2
                    exit 1
                  fi
                  # Check Google clientId
                  cid=$(jq -r '.identityProviders[0].config.clientId // empty' /tmp/ssm.generated.json)
                  echo "clientId=${cid}"
                  if [ "${cid}" != "ci-client-id" ]; then
                    echo "ERROR: Google clientId not set in generated ssm.json" >&2
                    exit 1
                  fi
                  ;;
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Run generator with example envs and validate
        env:
          # default empty envs (overridden per matrix below)
          FEDERATE_LDAP: ""
          LDAP_URL: ""
          USERSDN: ""
          GOOGLE_IDP: ""
          GOOGLE_CLIENT_ID: ""
          GOOGLE_SECRET: ""
        run: |
          set -euo pipefail
          case "${{ matrix.case }}" in
            ldap)
              echo "Testing LDAP patch case"
              FEDERATE_LDAP=true LDAP_URL="ldap://ldap.example.local" USERSDN="dc=example,dc=local" \
                keycloak/scripts/generate_ssm.sh > /tmp/ssm.generated.json
              jq empty /tmp/ssm.generated.json
              # Assert the LDAP URL was inserted into components[0].config.connectionUrl[0]
              jj=$(jq -r '.components[0].config.connectionUrl[0] // empty' /tmp/ssm.generated.json)
              echo "connectionUrl[0]=${jj}"
              if [ "${jj}" != "ldap://ldap.example.local" ]; then
                echo "ERROR: LDAP URL not found in generated ssm.json" >&2
                exit 1
              fi
              ;;
            google)
              echo "Testing Google IdP patch case"
              GOOGLE_IDP=true GOOGLE_CLIENT_ID="ci-client-id" GOOGLE_SECRET="ci-secret" \
                keycloak/scripts/generate_ssm.sh > /tmp/ssm.generated.json
              jq empty /tmp/ssm.generated.json
              # Assert client ID was inserted into identityProviders[0].config.clientId
              cid=$(jq -r '.identityProviders[0].config.clientId // empty' /tmp/ssm.generated.json)
              echo "clientId=${cid}"
              if [ "${cid}" != "ci-client-id" ]; then
                echo "ERROR: Google clientId not set in generated ssm.json" >&2
                exit 1
              fi
              ;;
            *)
              echo "Unknown case: ${{ matrix.case }}" >&2
              exit 1
              ;;
          esac
        shell: bash
